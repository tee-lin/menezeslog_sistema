<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - MenezesLog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #ffc107;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        
        .sidebar {
            background-color: var(--dark-color);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            padding-top: 20px;
            z-index: 100;
        }
        
        .sidebar .logo {
            text-align: center;
            padding: 10px 0 20px;
        }
        
        .sidebar .logo img {
            max-width: 180px;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 4px 16px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--secondary-color);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .top-bar {
            background-color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0b5ed7;
        }
        
        .btn-outline-secondary {
            color: #6c757d;
            border-color: #6c757d;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
        }
        
        .report-card {
            transition: all 0.3s;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .report-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        
        .table tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .badge-pending {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-completed {
            background-color: #198754;
            color: white;
        }
        
        .badge-yes {
            background-color: #198754;
            color: white;
        }
        
        .badge-no {
            background-color: #dc3545;
            color: white;
        }
        
        .action-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .filters {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="assets/MENEZESLOG-MarcaAzulH.png" alt="MenezesLog Logo">
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a href="admin_dashboard.html" class="nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="upload.html" class="nav-link">
                    <i class="bi bi-cloud-upload"></i> Upload de Arquivos
                </a>
            </li>
            <li class="nav-item">
                <a href="bonificacoes.html" class="nav-link">
                    <i class="bi bi-trophy"></i> Bonificações
                </a>
            </li>
            <li class="nav-item">
                <a href="descontos.html" class="nav-link">
                    <i class="bi bi-dash-circle"></i> Descontos
                </a>
            </li>
            <li class="nav-item">
                <a href="motoristas.html" class="nav-link">
                    <i class="bi bi-person"></i> Motoristas
                </a>
            </li>
            <li class="nav-item">
                <a href="relatorios.html" class="nav-link active">
                    <i class="bi bi-file-earmark-text"></i> Relatórios
                </a>
            </li>
            <li class="nav-item">
                <a href="configuracoes.html" class="nav-link">
                    <i class="bi bi-gear"></i> Configurações
                </a>
            </li>
            <li class="nav-item mt-5">
                <a href="#" class="nav-link" id="logout-btn">
                    <i class="bi bi-box-arrow-right"></i> Sair
                </a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h4 class="mb-0">Relatórios</h4>
            <div class="user-info">
                <img src="https://via.placeholder.com/40" alt="User Avatar">
                <div>
                    <h6 class="mb-0">Admin</h6>
                    <small class="text-muted">Administrador</small>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card report-card text-center">
                    <div class="card-body">
                        <i class="bi bi-file-earmark-pdf report-icon"></i>
                        <h5 class="card-title">Relatórios Individuais</h5>
                        <p class="card-text">Gere relatórios individuais para cada motorista com detalhes de pagamento.</p>
                        <button class="btn btn-primary" id="individual-reports-btn">
                            <i class="bi bi-download me-2"></i> Gerar Relatórios
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card report-card text-center">
                    <div class="card-body">
                        <i class="bi bi-file-earmark-zip report-icon"></i>
                        <h5 class="card-title">Relatórios em Lote</h5>
                        <p class="card-text">Baixe todos os relatórios de pagamento em um único arquivo ZIP.</p>
                        <button class="btn btn-primary" id="batch-reports-btn">
                            <i class="bi bi-download me-2"></i> Baixar Todos
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card report-card text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up report-icon"></i>
                        <h5 class="card-title">Relatório Resumido</h5>
                        <p class="card-text">Visualize um resumo geral de todos os pagamentos em um único relatório.</p>
                        <button class="btn btn-primary" id="summary-report-btn">
                            <i class="bi bi-download me-2"></i> Gerar Resumo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-check me-2"></i> Lista de Pagamentos
            </div>
            <div class="card-body">
                <div class="filters mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">Buscar</span>
                                <input type="text" class="form-control" id="search-input" placeholder="Nome ou ID do motorista">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text">Status</span>
                                <select class="form-select" id="status-filter">
                                    <option value="all">Todos</option>
                                    <option value="pending">Pendente</option>
                                    <option value="completed">Concluído</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text">Nota Fiscal</span>
                                <select class="form-select" id="invoice-filter">
                                    <option value="all">Todos</option>
                                    <option value="yes">Recebida</option>
                                    <option value="no">Pendente</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" id="apply-filters-btn">
                                <i class="bi bi-funnel me-2"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="payments-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome do Motorista</th>
                                <th>Valor</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Nota Fiscal</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table-body">
                            <!-- Dados serão carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span id="total-records">0</span> registros encontrados
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination">
                            <!-- Paginação será gerada via JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Carregamento -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <h5 id="loading-message">Gerando relatórios, por favor aguarde...</h5>
                    <div class="progress mt-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            // Elementos do DOM
            const paymentsTableBody = document.getElementById('payments-table-body');
            const totalRecords = document.getElementById('total-records');
            const pagination = document.getElementById('pagination');
            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            const invoiceFilter = document.getElementById('invoice-filter');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const individualReportsBtn = document.getElementById('individual-reports-btn');
            const batchReportsBtn = document.getElementById('batch-reports-btn');
            const summaryReportBtn = document.getElementById('summary-report-btn');
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            const loadingMessage = document.getElementById('loading-message');
            
            // Variáveis de estado
            let currentPage = 1;
            let itemsPerPage = 10;
            let filteredPayments = [];
            let allPayments = [];
            
            // Função para formatar valor monetário
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }
            
            // Função para formatar data
            function formatDate(dateString) {
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('pt-BR').format(date);
            }
            
            // Função para carregar pagamentos
            function loadPayments() {
                fetch('/api/payments', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar pagamentos');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        allPayments = data.payments;
                        applyFilters();
                    } else {
                        console.error('Erro:', data.error);
                        alert('Erro ao carregar pagamentos: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    
                    // Para fins de demonstração, carregar dados fictícios
                    allPayments = generateDummyPayments();
                    applyFilters();
                });
            }
            
            // Função para gerar dados fictícios (apenas para demonstração)
            function generateDummyPayments() {
                const dummyPayments = [];
                const statuses = ['pending', 'completed'];
                const names = [
                    'João da Silva', 'Maria Oliveira', 'Pedro Santos', 'Ana Souza', 
                    'Carlos Ferreira', 'Luiza Costa', 'Fernando Pereira', 'Juliana Lima',
                    'Roberto Almeida', 'Camila Rodrigues', 'Marcelo Gomes', 'Patricia Martins',
                    'Ricardo Barbosa', 'Fernanda Carvalho', 'Antonio Nascimento', 'Luciana Moreira'
                ];
                
                for (let i = 1; i <= 50; i++) {
                    const randomName = names[Math.floor(Math.random() * names.length)];
                    const randomAmount = (Math.random() * 5000 + 500).toFixed(2);
                    const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                    const randomInvoice = Math.random() > 0.5;
                    
                    const date = new Date();
                    date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                    
                    dummyPayments.push({
                        id: i,
                        driver_id: 100000 + i,
                        driver_name: randomName,
                        amount: parseFloat(randomAmount),
                        payment_date: date.toISOString(),
                        reference: `PAG-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`,
                        status: randomStatus,
                        invoice_received: randomInvoice
                    });
                }
                
                return dummyPayments;
            }
            
            // Função para aplicar filtros
            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                const invoiceValue = invoiceFilter.value;
                
                filteredPayments = allPayments.filter(payment => {
                    // Filtro de busca
                    const matchesSearch = payment.driver_name.toLowerCase().includes(searchTerm) || 
                                         payment.driver_id.toString().includes(searchTerm);
                    
                    // Filtro de status
                    const matchesStatus = statusValue === 'all' || payment.status === statusValue;
                    
                    // Filtro de nota fiscal
                    const matchesInvoice = invoiceValue === 'all' || 
                                          (invoiceValue === 'yes' && payment.invoice_received) || 
                                          (invoiceValue === 'no' && !payment.invoice_received);
                    
                    return matchesSearch && matchesStatus && matchesInvoice;
                });
                
                totalRecords.textContent = filteredPayments.length;
                renderTable();
                renderPagination();
            }
            
            // Função para renderizar a tabela
            function renderTable() {
                paymentsTableBody.innerHTML = '';
                
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, filteredPayments.length);
                
                if (filteredPayments.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="text-center">Nenhum pagamento encontrado</td>`;
                    paymentsTableBody.appendChild(row);
                    return;
                }
                
                for (let i = startIndex; i < endIndex; i++) {
                    const payment = filteredPayments[i];
                    const row = document.createElement('tr');
                    
                    const statusBadgeClass = payment.status === 'completed' ? 'badge-completed' : 'badge-pending';
                    const statusText = payment.status === 'completed' ? 'Concluído' : 'Pendente';
                    
                    const invoiceBadgeClass = payment.invoice_received ? 'badge-yes' : 'badge-no';
                    const invoiceText = payment.invoice_received ? 'Recebida' : 'Pendente';
                    
                    row.innerHTML = `
                        <td>${payment.driver_id}</td>
                        <td>${payment.driver_name}</td>
                        <td>${formatCurrency(payment.amount)}</td>
                        <td>${formatDate(payment.payment_date)}</td>
                        <td><span class="badge rounded-pill ${statusBadgeClass}">${statusText}</span></td>
                        <td><span class="badge rounded-pill ${invoiceBadgeClass}">${invoiceText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary action-btn view-report" data-id="${payment.id}">
                                <i class="bi bi-file-earmark-text"></i> Ver
                            </button>
                            <button class="btn btn-sm btn-success action-btn download-report" data-id="${payment.id}">
                                <i class="bi bi-download"></i> Baixar
                            </button>
                        </td>
                    `;
                    
                    paymentsTableBody.appendChild(row);
                }
                
                // Adicionar event listeners para os botões de ação
                document.querySelectorAll('.view-report').forEach(button => {
                    button.addEventListener('click', function() {
                        const paymentId = this.getAttribute('data-id');
                        viewReport(paymentId);
                    });
                });
                
                document.querySelectorAll('.download-report').forEach(button => {
                    button.addEventListener('click', function() {
                        const paymentId = this.getAttribute('data-id');
                        downloadReport(paymentId);
                    });
                });
            }
            
            // Função para renderizar a paginação
            function renderPagination() {
                pagination.innerHTML = '';
                
                const totalPages = Math.ceil(filteredPayments.length / itemsPerPage);
                
                if (totalPages <= 1) {
                    return;
                }
                
                // Botão Anterior
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
                pagination.appendChild(prevLi);
                
                if (currentPage > 1) {
                    prevLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage--;
                        renderTable();
                        renderPagination();
                    });
                }
                
                // Páginas
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    pagination.appendChild(pageLi);
                    
                    if (i !== currentPage) {
                        pageLi.addEventListener('click', function(e) {
                            e.preventDefault();
                            currentPage = i;
                            renderTable();
                            renderPagination();
                        });
                    }
                }
                
                // Botão Próximo
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
                pagination.appendChild(nextLi);
                
                if (currentPage < totalPages) {
                    nextLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage++;
                        renderTable();
                        renderPagination();
                    });
                }
            }
            
            // Função para visualizar relatório
            function viewReport(paymentId) {
                // Em produção, isso abriria o PDF em uma nova aba
                window.open(`/api/payments/${paymentId}/pdf`, '_blank');
            }
            
            // Função para baixar relatório
            function downloadReport(paymentId) {
                // Em produção, isso faria o download do PDF
                window.location.href = `/api/payments/${paymentId}/pdf`;
            }
            
            // Event listener para o botão de filtros
            applyFiltersBtn.addEventListener('click', function() {
                currentPage = 1;
                applyFilters();
            });
            
            // Event listener para o botão de relatórios individuais
            individualReportsBtn.addEventListener('click', function() {
                loadingMessage.textContent = 'Gerando relatórios individuais, por favor aguarde...';
                loadingModal.show();
                
                // Em produção, isso faria uma requisição para gerar os relatórios
                setTimeout(() => {
                    loadingModal.hide();
                    
                    // Simular download de um relatório específico
                    if (filteredPayments.length > 0) {
                        const randomIndex = Math.floor(Math.random() * filteredPayments.length);
                        const randomPayment = filteredPayments[randomIndex];
                        downloadReport(randomPayment.id);
                    } else {
                        alert('Nenhum pagamento encontrado para gerar relatórios.');
                    }
                }, 2000);
            });
            
            // Event listener para o botão de relatórios em lote
            batchReportsBtn.addEventListener('click', function() {
                loadingMessage.textContent = 'Gerando relatórios em lote, por favor aguarde...';
                loadingModal.show();
                
                // Em produção, isso faria uma requisição para gerar o ZIP com todos os relatórios
                setTimeout(() => {
                    loadingModal.hide();
                    
                    // Simular download do ZIP
                    window.location.href = '/api/relatorios/todos';
                }, 3000);
            });
            
            // Event listener para o botão de relatório resumido
            summaryReportBtn.addEventListener('click', function() {
                loadingMessage.textContent = 'Gerando relatório resumido, por favor aguarde...';
                loadingModal.show();
                
                // Em produção, isso faria uma requisição para gerar o relatório resumido
                setTimeout(() => {
                    loadingModal.hide();
                    
                    // Simular download do relatório resumido
                    window.location.href = '/api/relatorios/resumo';
                }, 2000);
            });
            
            // Event listener para o botão de logout
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            });
            
            // Navegação do menu lateral
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.getAttribute('href') !== '#') {
                        const href = this.getAttribute('href');
                        if (href && href !== '#') {
                            e.preventDefault();
                            window.location.href = href;
                        }
                    }
                });
            });
            
            // Carregar pagamentos ao iniciar
            loadPayments();
        });
    </script>
</body>
</html>
