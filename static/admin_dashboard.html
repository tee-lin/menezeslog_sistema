<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MenezesLog SaaS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Menu Lateral -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-truck"></i> MenezesLog</h3>
        </div>
        <ul class="sidebar-menu">
            <li><a href="admin_dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="prestadores.html"><i class="fas fa-users"></i> Prestadores</a></li>
            <li><a href="upload.html"><i class="fas fa-upload"></i> Upload</a></li>
            <li><a href="tarifas.html"><i class="fas fa-dollar-sign"></i> Tarifas</a></li>
            <li><a href="ciclos.html"><i class="fas fa-calendar"></i> Ciclos</a></li>
            <li><a href="awbs.html"><i class="fas fa-barcode"></i> AWBs</a></li>
        </ul>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                <p>Visão geral do sistema MenezesLog</p>
            </div>

            <!-- Cards de Estatísticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-prestadores">0</h3>
                        <p>Total de Prestadores</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-motoristas">0</h3>
                        <p>Total de Entregadores</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-barcode"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-awbs">0</h3>
                        <p>Total de AWBs</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="supabase-status">❌</h3>
                        <p>Status Supabase</p>
                    </div>
                </div>
            </div>

            <!-- Gráficos e Informações -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i> Distribuição de Prestadores</h3>
                    </div>
                    <div class="card-content">
                        <canvas id="prestadoresChart"></canvas>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Estatísticas do Sistema</h3>
                    </div>
                    <div class="card-content">
                        <div class="stats-list">
                            <div class="stats-item">
                                <span class="stats-label">Entregadores em Grupos:</span>
                                <span class="stats-value" id="motoristas-grupos">0</span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-label">Entregadores Individuais:</span>
                                <span class="stats-value" id="motoristas-individuais">0</span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-label">Última Atualização:</span>
                                <span class="stats-value" id="ultima-atualizacao">-</span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-label">Versão do Sistema:</span>
                                <span class="stats-value">v7.5 FINAL</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ações Rápidas -->
            <div class="quick-actions">
                <h3><i class="fas fa-bolt"></i> Ações Rápidas</h3>
                <div class="actions-grid">
                    <a href="prestadores.html" class="action-btn">
                        <i class="fas fa-users"></i>
                        <span>Gerenciar Prestadores</span>
                    </a>
                    <a href="upload.html" class="action-btn">
                        <i class="fas fa-upload"></i>
                        <span>Upload de Arquivos</span>
                    </a>
                    <a href="tarifas.html" class="action-btn">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Configurar Tarifas</span>
                    </a>
                    <a href="ciclos.html" class="action-btn">
                        <i class="fas fa-calendar"></i>
                        <span>Ciclos de Pagamento</span>
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Variáveis globais
        let prestadoresChart = null;

        // Carregar dados do dashboard
        async function carregarDashboard() {
            try {
                // Carregar estatísticas gerais
                const response = await fetch('/api/estatisticas');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        atualizarEstatisticas(data.data);
                    }
                }

                // Carregar estatísticas de prestadores
                const prestadoresResponse = await fetch('/api/prestadores/estatisticas');
                if (prestadoresResponse.ok) {
                    const prestadoresData = await prestadoresResponse.json();
                    if (prestadoresData.success) {
                        atualizarEstatisticasPrestadores(prestadoresData.data);
                        criarGraficoPrestadores(prestadoresData.data);
                    }
                }

                // Atualizar timestamp
                document.getElementById('ultima-atualizacao').textContent = 
                    new Date().toLocaleString('pt-BR');

            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        // Atualizar estatísticas gerais
        function atualizarEstatisticas(data) {
            document.getElementById('total-prestadores').textContent = data.total_prestadores || 0;
            document.getElementById('total-motoristas').textContent = data.total_motoristas || 0;
            document.getElementById('total-awbs').textContent = data.total_awbs || 0;
            document.getElementById('supabase-status').textContent = data.supabase_connected ? '✅' : '❌';
        }

        // Atualizar estatísticas de prestadores
        function atualizarEstatisticasPrestadores(data) {
            document.getElementById('motoristas-grupos').textContent = data.motoristas_em_grupos || 0;
            document.getElementById('motoristas-individuais').textContent = data.motoristas_individuais || 0;
        }

        // Criar gráfico de prestadores
        function criarGraficoPrestadores(data) {
            const ctx = document.getElementById('prestadoresChart').getContext('2d');
            
            // Destruir gráfico anterior se existir
            if (prestadoresChart) {
                prestadoresChart.destroy();
            }

            prestadoresChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Em Grupos', 'Individuais'],
                    datasets: [{
                        data: [data.motoristas_em_grupos || 0, data.motoristas_individuais || 0],
                        backgroundColor: [
                            '#4CAF50',
                            '#2196F3'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Atualizar dados a cada 30 segundos
        function iniciarAtualizacaoAutomatica() {
            setInterval(carregarDashboard, 30000);
        }

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            carregarDashboard();
            iniciarAtualizacaoAutomatica();
        });
    </script>
</body>
</html>

