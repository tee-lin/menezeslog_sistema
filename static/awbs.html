<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de AWBs - MenezesLog</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-truck"></i> MenezesLog</h3>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/admin_dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li><a href="/prestadores.html"><i class="fas fa-users"></i> Prestadores</a></li>
            <li><a href="/upload.html"><i class="fas fa-upload"></i> Upload</a></li>
            <li><a href="/tarifas.html"><i class="fas fa-dollar-sign"></i> Tarifas</a></li>
            <li><a href="/ciclos.html"><i class="fas fa-calendar-alt"></i> Ciclos</a></li>
            <li><a href="/awbs.html" class="active"><i class="fas fa-barcode"></i> AWBs</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-barcode"></i> Gestão de AWBs</h1>
                <p>Consulte e gerencie códigos de rastreamento de entregas</p>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-barcode"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-awbs">0</h3>
                        <p>Total de AWBs</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="awbs-entregues">0</h3>
                        <p>Entregues</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="awbs-pendentes">0</h3>
                        <p>Pendentes</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="valor-total-awbs">R$ 0,00</h3>
                        <p>Valor Total</p>
                    </div>
                </div>
            </div>

            <!-- Filtros Avançados -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-filter"></i> Filtros Avançados</h3>
                </div>
                <div class="card-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="search-awb">Buscar AWB</label>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="search-awb" placeholder="Digite o código AWB...">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="filter-motorista">Entregador</label>
                            <select id="filter-motorista">
                                <option value="">Todos os entregadores</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-status">Status</label>
                            <select id="filter-status">
                                <option value="">Todos os status</option>
                                <option value="NAO_PAGA">Não Paga</option>
                                <option value="PAGA">Paga</option>
                                <option value="PROCESSANDO">Processando</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-tipo">Tipo de Serviço</label>
                            <select id="filter-tipo">
                                <option value="">Todos os tipos</option>
                                <option value="0">Encomendas (R$ 3,50)</option>
                                <option value="9">Cards (R$ 2,00)</option>
                                <option value="6">Revistas (R$ 0,50)</option>
                                <option value="8">Revistas (R$ 0,50)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-data-inicio">Data Início</label>
                            <input type="date" id="filter-data-inicio">
                        </div>
                        <div class="form-group">
                            <label for="filter-data-fim">Data Fim</label>
                            <input type="date" id="filter-data-fim">
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button class="btn btn-secondary" onclick="limparFiltros()">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                        <button class="btn btn-success" onclick="exportarDados()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resultados -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> Lista de AWBs</h3>
                    <div class="card-actions">
                        <span id="total-resultados" class="status-badge success">0 AWBs</span>
                        <button class="btn btn-secondary btn-sm" onclick="atualizarLista()">
                            <i class="fas fa-sync"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="loading-awbs" class="loading-section">
                        <div class="loading-card">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando AWBs...</p>
                        </div>
                    </div>
                    
                    <div id="lista-awbs" style="display: none;">
                        <!-- Lista será preenchida via JavaScript -->
                    </div>
                    
                    <div id="empty-awbs" class="empty-state" style="display: none;">
                        <i class="fas fa-barcode"></i>
                        <h3>Nenhuma AWB encontrada</h3>
                        <p>Faça upload de arquivos CSV para ver as AWBs aqui</p>
                    </div>

                    <!-- Paginação -->
                    <div id="paginacao" class="pagination" style="display: none;">
                        <button class="btn btn-secondary btn-sm" onclick="paginaAnterior()">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span id="info-pagina">Página 1 de 1</span>
                        <button class="btn btn-secondary btn-sm" onclick="proximaPagina()">
                            Próxima <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let awbs = [];
        let awbsFiltradas = [];
        let paginaAtual = 1;
        const itensPorPagina = 50;

        // Carregar AWBs
        async function carregarAWBs() {
            try {
                document.getElementById('loading-awbs').style.display = 'block';
                document.getElementById('lista-awbs').style.display = 'none';
                document.getElementById('empty-awbs').style.display = 'none';
                
                const response = await fetch('/api/awbs');
                if (response.ok) {
                    awbs = await response.json();
                } else {
                    // Dados simulados para demonstração
                    awbs = [
                        {
                            id: 1,
                            awb: "TXAS531420040tx",
                            id_motorista: 270756,
                            nome_motorista: "João Silva",
                            tipo_servico: 0,
                            valor_entrega: 3.50,
                            status: "NAO_PAGA",
                            data_entrega: "2025-06-09",
                            created_at: "2025-06-09T10:30:00Z"
                        },
                        {
                            id: 2,
                            awb: "CARD123456789",
                            id_motorista: 270756,
                            nome_motorista: "João Silva",
                            tipo_servico: 9,
                            valor_entrega: 2.00,
                            status: "PAGA",
                            data_entrega: "2025-06-08",
                            created_at: "2025-06-08T14:20:00Z"
                        }
                    ];
                }
                
                awbsFiltradas = [...awbs];
                await carregarMotoristas();
                renderizarLista();
                atualizarEstatisticas();
                
                document.getElementById('loading-awbs').style.display = 'none';
                document.getElementById('lista-awbs').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar AWBs:', error);
                document.getElementById('loading-awbs').style.display = 'none';
                document.getElementById('empty-awbs').style.display = 'block';
            }
        }

        async function carregarMotoristas() {
            try {
                const response = await fetch('/api/motoristas');
                let motoristas = [];
                
                if (response.ok) {
                    motoristas = await response.json();
                } else {
                    // Dados simulados
                    motoristas = [
                        { id_motorista: 270756, nome_motorista: "João Silva" },
                        { id_motorista: 123456, nome_motorista: "Maria Santos" }
                    ];
                }
                
                const select = document.getElementById('filter-motorista');
                select.innerHTML = '<option value="">Todos os entregadores</option>';
                
                motoristas.forEach(motorista => {
                    const option = document.createElement('option');
                    option.value = motorista.id_motorista;
                    option.textContent = `${motorista.nome_motorista} (${motorista.id_motorista})`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Erro ao carregar motoristas:', error);
            }
        }

        function renderizarLista() {
            const container = document.getElementById('lista-awbs');
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const awbsPagina = awbsFiltradas.slice(inicio, fim);
            
            if (awbsPagina.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><h3>Nenhum resultado encontrado</h3></div>';
                document.getElementById('paginacao').style.display = 'none';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table"><thead><tr>';
            html += '<th>AWB</th><th>Entregador</th><th>Tipo</th><th>Valor</th><th>Status</th><th>Data</th><th>Ações</th>';
            html += '</tr></thead><tbody>';
            
            awbsPagina.forEach(awb => {
                const statusClass = awb.status === 'PAGA' ? 'success' : 
                                  awb.status === 'PROCESSANDO' ? 'warning' : 'error';
                
                const tipoTexto = awb.tipo_servico === 0 ? 'Encomenda' :
                                awb.tipo_servico === 9 ? 'Card' : 'Revista';
                
                html += `
                    <tr>
                        <td><strong>${awb.awb}</strong></td>
                        <td>${awb.nome_motorista}<br><small>${awb.id_motorista}</small></td>
                        <td>${tipoTexto}<br><small>Tipo ${awb.tipo_servico}</small></td>
                        <td><strong>R$ ${awb.valor_entrega.toFixed(2)}</strong></td>
                        <td><span class="status-badge ${statusClass}">${awb.status.replace('_', ' ')}</span></td>
                        <td>${new Date(awb.data_entrega).toLocaleDateString('pt-BR')}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="verDetalhes('${awb.awb}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${awb.status === 'NAO_PAGA' ? 
                                `<button class="btn btn-success btn-sm" onclick="marcarPaga('${awb.awb}')">
                                    <i class="fas fa-check"></i>
                                </button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
            
            // Atualizar paginação
            const totalPaginas = Math.ceil(awbsFiltradas.length / itensPorPagina);
            document.getElementById('info-pagina').textContent = `Página ${paginaAtual} de ${totalPaginas}`;
            document.getElementById('paginacao').style.display = totalPaginas > 1 ? 'flex' : 'none';
            
            // Atualizar contador
            document.getElementById('total-resultados').textContent = `${awbsFiltradas.length} AWBs`;
        }

        function atualizarEstatisticas() {
            const total = awbs.length;
            const entregues = awbs.filter(a => a.status === 'PAGA').length;
            const pendentes = awbs.filter(a => a.status === 'NAO_PAGA').length;
            const valorTotal = awbs.reduce((sum, a) => sum + a.valor_entrega, 0);
            
            document.getElementById('total-awbs').textContent = total.toLocaleString('pt-BR');
            document.getElementById('awbs-entregues').textContent = entregues.toLocaleString('pt-BR');
            document.getElementById('awbs-pendentes').textContent = pendentes.toLocaleString('pt-BR');
            document.getElementById('valor-total-awbs').textContent = `R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function aplicarFiltros() {
            const termoBusca = document.getElementById('search-awb').value.toLowerCase();
            const motorista = document.getElementById('filter-motorista').value;
            const status = document.getElementById('filter-status').value;
            const tipo = document.getElementById('filter-tipo').value;
            const dataInicio = document.getElementById('filter-data-inicio').value;
            const dataFim = document.getElementById('filter-data-fim').value;
            
            awbsFiltradas = awbs.filter(awb => {
                const awbMatch = awb.awb.toLowerCase().includes(termoBusca) ||
                               awb.nome_motorista.toLowerCase().includes(termoBusca);
                const motoristaMatch = !motorista || awb.id_motorista.toString() === motorista;
                const statusMatch = !status || awb.status === status;
                const tipoMatch = !tipo || awb.tipo_servico.toString() === tipo;
                
                let dataMatch = true;
                if (dataInicio || dataFim) {
                    const dataAwb = new Date(awb.data_entrega);
                    if (dataInicio) dataMatch = dataMatch && dataAwb >= new Date(dataInicio);
                    if (dataFim) dataMatch = dataMatch && dataAwb <= new Date(dataFim);
                }
                
                return awbMatch && motoristaMatch && statusMatch && tipoMatch && dataMatch;
            });
            
            paginaAtual = 1;
            renderizarLista();
        }

        function limparFiltros() {
            document.getElementById('search-awb').value = '';
            document.getElementById('filter-motorista').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-tipo').value = '';
            document.getElementById('filter-data-inicio').value = '';
            document.getElementById('filter-data-fim').value = '';
            
            awbsFiltradas = [...awbs];
            paginaAtual = 1;
            renderizarLista();
        }

        function paginaAnterior() {
            if (paginaAtual > 1) {
                paginaAtual--;
                renderizarLista();
            }
        }

        function proximaPagina() {
            const totalPaginas = Math.ceil(awbsFiltradas.length / itensPorPagina);
            if (paginaAtual < totalPaginas) {
                paginaAtual++;
                renderizarLista();
            }
        }

        function atualizarLista() {
            carregarAWBs();
        }

        function verDetalhes(awb) {
            const item = awbs.find(a => a.awb === awb);
            if (item) {
                alert(`Detalhes da AWB:\n\nCódigo: ${item.awb}\nEntregador: ${item.nome_motorista} (${item.id_motorista})\nTipo: ${item.tipo_servico}\nValor: R$ ${item.valor_entrega.toFixed(2)}\nStatus: ${item.status}\nData: ${new Date(item.data_entrega).toLocaleDateString('pt-BR')}`);
            }
        }

        function marcarPaga(awb) {
            if (confirm(`Marcar AWB ${awb} como PAGA?`)) {
                // Aqui implementaria a chamada para a API
                alert(`AWB ${awb} marcada como PAGA!`);
                carregarAWBs(); // Recarregar lista
            }
        }

        function exportarDados() {
            // Implementar exportação para CSV/Excel
            alert('Exportação em desenvolvimento - será implementada na próxima versão');
        }

        // Event listeners para filtros em tempo real
        document.getElementById('search-awb').addEventListener('input', aplicarFiltros);
        document.getElementById('filter-motorista').addEventListener('change', aplicarFiltros);
        document.getElementById('filter-status').addEventListener('change', aplicarFiltros);
        document.getElementById('filter-tipo').addEventListener('change', aplicarFiltros);
        document.getElementById('filter-data-inicio').addEventListener('change', aplicarFiltros);
        document.getElementById('filter-data-fim').addEventListener('change', aplicarFiltros);

        // Carregar dados ao inicializar
        document.addEventListener('DOMContentLoaded', carregarAWBs);
    </script>
</body>
</html>

