<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MenezesLog SaaS - Gestão de Prestadores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* CORREÇÃO CRÍTICA: Z-index do modal */
        .modal {
            z-index: 1060 !important;
        }
        
        .modal-backdrop {
            z-index: 1050 !important;
        }
        
        .modal-dialog {
            z-index: 1070 !important;
            position: relative;
        }
        
        /* Estilos específicos da página Prestadores */
        .prestador-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .prestador-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .motorista-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .motorista-card:hover {
            border-color: #007bff;
            transform: translateX(5px);
        }
        
        .motorista-principal {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .motorista-ajudante {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }
        
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #0056b3;
            background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        
        .btn-criar-grupo {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-criar-grupo:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
            color: white;
        }
        
        .grupo-badge {
            background: linear-gradient(45deg, #6f42c1, #5a2d91);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .nav-menu .nav-item .nav-link {
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 2px 8px;
        }
        
        .nav-menu .nav-item .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .nav-menu .nav-item .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #fff;
        }
        
        .nav-icon {
            width: 20px;
            text-align: center;
        }
        
        /* Garantir que botões do modal sejam clicáveis */
        .modal-footer .btn {
            z-index: 1080 !important;
            position: relative;
        }
        
        .modal-body .form-control,
        .modal-body .form-select {
            z-index: 1075 !important;
            position: relative;
        }
    </style>
</head>
<body>
    <!-- Cabeçalho -->
    <header class="header">
        <div class="container-fluid">
            <div class="header-content">
                <div class="d-flex align-items-center">
                    <button id="sidebar-toggle" class="btn btn-light me-2">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">
                        <img src="assets/MENEZESLOG-MarcaAzulH.png" alt="MenezesLog Logo">
                    </div>
                    <span class="badge bg-primary ms-2">SaaS v6.2</span>
                </div>
                <div class="user-info">
                    <div class="dropdown">
                        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <div class="avatar me-2">A</div>
                            <div>
                                <div class="user-name">Administrador</div>
                                <div class="user-role text-muted small">Gestão de Prestadores</div>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="configuracoes.html"><i class="fas fa-cog me-2"></i>Configurações</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navegação Lateral ATUALIZADA -->
    <aside class="sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="admin_dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt nav-icon"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="prestadores.html" class="nav-link active">
                        <i class="fas fa-users-cog nav-icon"></i>
                        <span>Prestadores</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="tarifas.html" class="nav-link">
                        <i class="fas fa-money-bill-wave nav-icon"></i>
                        <span>Tarifas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="ciclos.html" class="nav-link">
                        <i class="fas fa-calendar-alt nav-icon"></i>
                        <span>Ciclos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="awbs.html" class="nav-link">
                        <i class="fas fa-barcode nav-icon"></i>
                        <span>AWBs</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="upload.html" class="nav-link">
                        <i class="fas fa-upload nav-icon"></i>
                        <span>Upload</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="relatorios.html" class="nav-link">
                        <i class="fas fa-chart-bar nav-icon"></i>
                        <span>Relatórios</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="configuracoes.html" class="nav-link">
                        <i class="fas fa-cog nav-icon"></i>
                        <span>Configurações</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Cabeçalho da Página -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-0">
                                <i class="fas fa-users-cog me-2 text-primary"></i>
                                Gestão de Prestadores
                            </h1>
                            <p class="text-muted mb-0">Gerencie motoristas e grupos de prestadores</p>
                        </div>
                        <div class="grupo-badge">
                            <i class="fas fa-rocket me-1"></i>
                            Sistema SaaS v6.2
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">Motoristas</h6>
                                <h3 class="mb-0" id="total-motoristas">0</h3>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-truck fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">Prestadores</h6>
                                <h3 class="mb-0" id="total-prestadores">0</h3>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-users-cog fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">Em Grupos</h6>
                                <h3 class="mb-0" id="motoristas-grupos">0</h3>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">Individuais</h6>
                                <h3 class="mb-0" id="motoristas-individuais">0</h3>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-user fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload de Motoristas -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-upload me-2"></i>
                                Upload Planilha DE-PARA
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="upload-area">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                <h5>Arraste a planilha DE-PARA aqui</h5>
                                <p class="text-muted">ou clique para selecionar arquivo (.xlsx, .xls, .csv)</p>
                                <input type="file" id="file-input" class="d-none" accept=".xlsx,.xls,.csv">
                                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                                    <i class="fas fa-folder-open me-2"></i>
                                    Selecionar Arquivo
                                </button>
                            </div>
                            <div id="upload-status" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Motoristas e Prestadores -->
            <div class="row">
                <!-- Motoristas Disponíveis -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-truck me-2"></i>
                                Motoristas Disponíveis
                            </h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="recarregarMotoristas()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="lista-motoristas">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-upload fa-2x mb-2"></i>
                                    <p>Faça upload da planilha DE-PARA para carregar os motoristas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grupos de Prestadores -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-users-cog me-2"></i>
                                Grupos de Prestadores
                            </h5>
                            <button class="btn btn-sm btn-success" onclick="abrirModalCriarGrupo()">
                                <i class="fas fa-plus me-1"></i>
                                Criar Grupo
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="lista-prestadores">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-users-cog fa-2x mb-2"></i>
                                    <p>Nenhum grupo criado ainda</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Criar Grupo - CORRIGIDO -->
    <div class="modal fade" id="modalCriarGrupo" tabindex="-1" aria-labelledby="modalCriarGrupoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCriarGrupoLabel">
                        <i class="fas fa-users-cog me-2"></i>
                        Criar Grupo de Prestadores
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-criar-grupo">
                        <div class="mb-3">
                            <label for="motorista-principal" class="form-label">Motorista Principal</label>
                            <select class="form-select" id="motorista-principal" required>
                                <option value="">Selecione o motorista principal</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="nome-prestador" class="form-label">Nome do Prestador</label>
                            <input type="text" class="form-control" id="nome-prestador" placeholder="Nome será preenchido automaticamente" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="motoristas-ajudantes" class="form-label">Motoristas Ajudantes (opcional)</label>
                            <select class="form-select" id="motoristas-ajudantes" multiple size="4">
                                <!-- Preenchido dinamicamente -->
                            </select>
                            <div class="form-text">Segure Ctrl para selecionar múltiplos motoristas</div>
                        </div>
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" rows="3" placeholder="Observações sobre o grupo..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="criarGrupo()">
                        <i class="fas fa-save me-2"></i>
                        Criar Grupo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('[Prestadores] Sistema de gestão de prestadores v6.2 carregado!');
        
        let motoristas = [];
        let prestadores = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            carregarMotoristas();
            carregarPrestadores();
            carregarEstatisticas();
            configurarUpload();
            configurarSidebar();
        });

        // Configurar sidebar
        function configurarSidebar() {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                });
            }
        }

        // Configurar upload
        function configurarUpload() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processarArquivo(files[0]);
                }
            });

            // Click para upload
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    processarArquivo(e.target.files[0]);
                }
            });
        }

        // Processar arquivo
        function processarArquivo(file) {
            const statusDiv = document.getElementById('upload-status');
            
            // Validar tipo de arquivo
            const allowedTypes = ['.xlsx', '.xls', '.csv'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Tipo de arquivo não permitido. Use .xlsx, .xls ou .csv
                    </div>
                `;
                return;
            }

            // Mostrar loading
            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Processando planilha DE-PARA...
                </div>
            `;

            // Upload
            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/motoristas/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                    
                    // Recarregar listas
                    carregarMotoristas();
                    carregarEstatisticas();
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro no upload:', error);
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao processar arquivo: ${error.message}
                    </div>
                `;
            });
        }

        // Carregar motoristas
        function carregarMotoristas() {
            fetch('/api/motoristas')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    motoristas = data.data;
                    renderizarMotoristas();
                    atualizarSelectsModal();
                }
            })
            .catch(error => {
                console.error('Erro ao carregar motoristas:', error);
            });
        }

        // Renderizar motoristas
        function renderizarMotoristas() {
            const container = document.getElementById('lista-motoristas');
            
            if (motoristas.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-upload fa-2x mb-2"></i>
                        <p>Faça upload da planilha DE-PARA para carregar os motoristas</p>
                    </div>
                `;
                return;
            }

            const html = motoristas.map(motorista => `
                <div class="motorista-card" data-id="${motorista.id_motorista}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${motorista.nome_motorista}</h6>
                            <small class="text-muted">ID: ${motorista.id_motorista}</small>
                        </div>
                        <button class="btn btn-criar-grupo btn-sm" onclick="criarGrupoRapido(${motorista.id_motorista})">
                            <i class="fas fa-plus me-1"></i>
                            Criar Grupo
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Carregar prestadores
        function carregarPrestadores() {
            fetch('/api/prestadores')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    prestadores = data.data;
                    renderizarPrestadores();
                }
            })
            .catch(error => {
                console.error('Erro ao carregar prestadores:', error);
            });
        }

        // Renderizar prestadores
        function renderizarPrestadores() {
            const container = document.getElementById('lista-prestadores');
            
            if (prestadores.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-users-cog fa-2x mb-2"></i>
                        <p>Nenhum grupo criado ainda</p>
                    </div>
                `;
                return;
            }

            const html = prestadores.map(prestador => {
                const principal = motoristas.find(m => m.id_motorista === prestador.motorista_principal);
                const ajudantes = prestador.motoristas_ajudantes.map(id => 
                    motoristas.find(m => m.id_motorista === id)
                ).filter(Boolean);

                return `
                    <div class="prestador-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">${prestador.nome_prestador}</h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editarPrestador(${prestador.id})">
                                        <i class="fas fa-edit me-2"></i>Editar
                                    </a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="excluirPrestador(${prestador.id})">
                                        <i class="fas fa-trash me-2"></i>Excluir
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <span class="badge bg-success me-1">
                                <i class="fas fa-crown me-1"></i>
                                ${principal ? principal.nome_motorista : 'N/A'}
                            </span>
                            ${ajudantes.map(ajudante => `
                                <span class="badge bg-warning text-dark me-1">
                                    ${ajudante.nome_motorista}
                                </span>
                            `).join('')}
                        </div>
                        
                        ${prestador.observacoes ? `
                            <small class="text-muted">${prestador.observacoes}</small>
                        ` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Carregar estatísticas
        function carregarEstatisticas() {
            fetch('/api/prestadores/estatisticas')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('total-motoristas').textContent = data.data.total_motoristas;
                    document.getElementById('total-prestadores').textContent = data.data.total_prestadores;
                    document.getElementById('motoristas-grupos').textContent = data.data.motoristas_em_grupos;
                    document.getElementById('motoristas-individuais').textContent = data.data.motoristas_individuais;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar estatísticas:', error);
            });
        }

        // Atualizar selects do modal
        function atualizarSelectsModal() {
            const selectPrincipal = document.getElementById('motorista-principal');
            const selectAjudantes = document.getElementById('motoristas-ajudantes');

            // Limpar selects
            selectPrincipal.innerHTML = '<option value="">Selecione o motorista principal</option>';
            selectAjudantes.innerHTML = '';

            // Preencher com motoristas
            motoristas.forEach(motorista => {
                selectPrincipal.innerHTML += `
                    <option value="${motorista.id_motorista}">${motorista.nome_motorista}</option>
                `;
                selectAjudantes.innerHTML += `
                    <option value="${motorista.id_motorista}">${motorista.nome_motorista}</option>
                `;
            });

            // Auto-preencher nome do prestador
            selectPrincipal.addEventListener('change', function() {
                const motoristaId = parseInt(this.value);
                const motorista = motoristas.find(m => m.id_motorista === motoristaId);
                
                if (motorista) {
                    document.getElementById('nome-prestador').value = motorista.nome_motorista;
                } else {
                    document.getElementById('nome-prestador').value = '';
                }
            });
        }

        // Abrir modal criar grupo
        function abrirModalCriarGrupo() {
            const modal = new bootstrap.Modal(document.getElementById('modalCriarGrupo'));
            modal.show();
        }

        // Criar grupo rápido
        function criarGrupoRapido(motoristaId) {
            const motorista = motoristas.find(m => m.id_motorista === motoristaId);
            if (motorista) {
                document.getElementById('motorista-principal').value = motoristaId;
                document.getElementById('nome-prestador').value = motorista.nome_motorista;
                abrirModalCriarGrupo();
            }
        }

        // Criar grupo
        function criarGrupo() {
            const form = document.getElementById('form-criar-grupo');
            
            const data = {
                motorista_principal: parseInt(document.getElementById('motorista-principal').value),
                nome_prestador: document.getElementById('nome-prestador').value,
                motoristas_ajudantes: Array.from(document.getElementById('motoristas-ajudantes').selectedOptions).map(option => parseInt(option.value)),
                observacoes: document.getElementById('observacoes').value
            };

            if (!data.motorista_principal || !data.nome_prestador) {
                alert('Preencha os campos obrigatórios');
                return;
            }

            fetch('/api/prestadores', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalCriarGrupo'));
                    modal.hide();
                    
                    // Limpar form
                    form.reset();
                    document.getElementById('nome-prestador').value = '';
                    
                    // Recarregar listas
                    carregarPrestadores();
                    carregarEstatisticas();
                    
                    // Mostrar sucesso
                    alert(result.message);
                } else {
                    alert('Erro: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Erro ao criar grupo:', error);
                alert('Erro ao criar grupo');
            });
        }

        // Excluir prestador
        function excluirPrestador(prestadorId) {
            if (confirm('Tem certeza que deseja excluir este prestador?')) {
                fetch(`/api/prestadores/${prestadorId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        carregarPrestadores();
                        carregarEstatisticas();
                        alert(result.message);
                    } else {
                        alert('Erro: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Erro ao excluir prestador:', error);
                    alert('Erro ao excluir prestador');
                });
            }
        }

        // Recarregar motoristas
        function recarregarMotoristas() {
            carregarMotoristas();
            carregarEstatisticas();
        }

        // Logout
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('menezeslog_logged_in');
                localStorage.removeItem('menezeslog_user');
                window.location.href = 'index.html';
            }
        }

        // Verificar autenticação
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('menezeslog_logged_in');
            if (isLoggedIn !== 'true') {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Verificar auth na inicialização
        checkAuth();
    </script>
</body>
</html>

