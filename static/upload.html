<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[v2] MenezesLog - Upload de Arquivos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Cabeçalho -->
    <header class="header">
        <div class="container-fluid">
            <div class="header-content">
                <div class="d-flex align-items-center">
                    <button id="sidebar-toggle" class="btn btn-light me-2">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">
                        <img src="assets/MENEZESLOG-MarcaAzulH.png" alt="MenezesLog Logo">
                    </div>
                </div>
                <div class="user-info" id="user-info">
                    <div class="dropdown">
                        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="avatar me-2">A</div>
                            <div>
                                <div class="user-name">Administrador</div>
                                <div class="user-role text-muted small">Admin</div>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="perfil.html"><i class="fas fa-user me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item" href="configuracoes.html"><i class="fas fa-cog me-2"></i>Configurações</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-button"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navegação Lateral -->
    <aside class="sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="admin_dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt nav-icon"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="motoristas.html" class="nav-link">
                        <i class="fas fa-truck nav-icon"></i>
                        <span>Motoristas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="bonificacoes.html" class="nav-link">
                        <i class="fas fa-award nav-icon"></i>
                        <span>Bonificações</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="descontos.html" class="nav-link">
                        <i class="fas fa-minus-circle nav-icon"></i>
                        <span>Descontos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="upload.html" class="nav-link active">
                        <i class="fas fa-upload nav-icon"></i>
                        <span>Upload</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="relatorios.html" class="nav-link">
                        <i class="fas fa-chart-bar nav-icon"></i>
                        <span>Relatórios</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="nota_fiscal.html" class="nav-link">
                        <i class="fas fa-file-invoice nav-icon"></i>
                        <span>Notas Fiscais</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="configuracoes.html" class="nav-link">
                        <i class="fas fa-cog nav-icon"></i>
                        <span>Configurações</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="main-content" id="main-content">
        <div class="container-fluid">
            <h1 class="mb-4">Upload de Arquivos</h1>
            
            <!-- Área de Upload -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Enviar Novo Arquivo</h5>
                </div>
                <div class="card-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="file-type" class="form-label">Tipo de Arquivo</label>
                                <select class="form-select" id="file-type" required>
                                    <option value="">Selecione o tipo de arquivo...</option>
                                    <option value="payment">Pagamentos</option>
                                    <option value="bonus">Bonificações</option>
                                    <option value="discount">Descontos</option>
                                    <option value="driver">Motoristas</option>
                                    <option value="other">Outro</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="file-description" class="form-label">Descrição</label>
                                <input type="text" class="form-control" id="file-description" placeholder="Descrição do arquivo">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="file-input" class="form-label">Selecione o arquivo</label>
                            <input class="form-control" type="file" id="file-input" required>
                            <div class="form-text">Formatos aceitos: CSV, XLS, XLSX (máx. 10MB)</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="process-immediately">
                                <label class="form-check-label" for="process-immediately">
                                    Processar imediatamente após upload
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary" id="upload-button">
                                <i class="fas fa-upload me-2"></i>Enviar Arquivo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Histórico de Uploads -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Histórico de Uploads</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="refresh-history-button">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-filter me-1"></i>Filtrar
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                                <li><a class="dropdown-item" href="#" data-filter="all">Todos</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="pending">Pendentes</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="processing">Em Processamento</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="completed">Concluídos</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="error">Com Erro</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Arquivo</th>
                                    <th>Tipo</th>
                                    <th>Data de Upload</th>
                                    <th>Tamanho</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="upload-history-table">
                                <tr>
                                    <td colspan="6" class="text-center">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-container" class="mt-4">
                        <!-- Paginação será inserida via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Detalhes do Upload -->
    <div class="modal fade" id="uploadDetailsModal" tabindex="-1" aria-labelledby="uploadDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadDetailsModalLabel">Detalhes do Upload</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informações do Arquivo</h6>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Nome do Arquivo:</th>
                                    <td id="detail-filename"></td>
                                </tr>
                                <tr>
                                    <th>Tipo:</th>
                                    <td id="detail-type"></td>
                                </tr>
                                <tr>
                                    <th>Descrição:</th>
                                    <td id="detail-description"></td>
                                </tr>
                                <tr>
                                    <th>Data de Upload:</th>
                                    <td id="detail-upload-date"></td>
                                </tr>
                                <tr>
                                    <th>Tamanho:</th>
                                    <td id="detail-size"></td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td id="detail-status"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Resultado do Processamento</h6>
                            <div id="detail-processing-result" class="border p-2 rounded" style="max-height: 200px; overflow-y: auto;">
                                <div class="text-center">Carregando...</div>
                            </div>
                            
                            <h6 class="mt-3">Estatísticas</h6>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Total de Registros:</th>
                                    <td id="detail-total-records"></td>
                                </tr>
                                <tr>
                                    <th>Registros Processados:</th>
                                    <td id="detail-processed-records"></td>
                                </tr>
                                <tr>
                                    <th>Registros com Erro:</th>
                                    <td id="detail-error-records"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Prévia dos Dados</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm" id="detail-data-preview">
                                <thead>
                                    <tr>
                                        <th colspan="5" class="text-center">Carregando prévia...</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-3" id="error-log-container" style="display: none;">
                        <h6>Log de Erros</h6>
                        <div class="border p-2 rounded bg-light" style="max-height: 200px; overflow-y: auto;">
                            <pre id="detail-error-log" class="mb-0"></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="download-file-button">
                        <i class="fas fa-download me-2"></i>Baixar Arquivo
                    </button>
                    <button type="button" class="btn btn-success" id="process-file-button">
                        <i class="fas fa-cogs me-2"></i>Processar Arquivo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o arquivo <strong id="delete-filename"></strong>?</p>
                    <p class="text-danger">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-button">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Progresso de Upload -->
    <div class="modal fade" id="uploadProgressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="uploadProgressModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadProgressModalLabel">Enviando Arquivo</h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                    <div class="progress mb-3">
                        <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <p class="text-center" id="upload-status-text">Iniciando upload...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Rodapé -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="footer-text">
                <p>© 2025 MenezesLog - Sistema de Pagamento de Motoristas</p>
                <p class="text-muted small">Versão 1.0.0</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main_v2.js"></script>
    <script>
        // Variáveis globais
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 10;
        let currentFilter = 'all';
        let selectedUploadId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar histórico de uploads
            loadUploadHistory();
            
            // Configurar formulário de upload
            document.getElementById('upload-form').addEventListener('submit', handleFileUpload);
            
            // Configurar botão de atualização
            document.getElementById('refresh-history-button').addEventListener('click', function() {
                loadUploadHistory();
            });
            
            // Configurar filtros
            document.querySelectorAll('.dropdown-item[data-filter]').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentFilter = this.dataset.filter;
                    currentPage = 1;
                    loadUploadHistory();
                });
            });
            
            // Configurar botões do modal de detalhes
            document.getElementById('download-file-button').addEventListener('click', downloadFile);
            document.getElementById('process-file-button').addEventListener('click', processFile);
            
            // Configurar botão de confirmação de exclusão
            document.getElementById('confirm-delete-button').addEventListener('click', deleteFile);
        });
        
        // Função para carregar histórico de uploads
        function loadUploadHistory() {
            const tableBody = document.getElementById('upload-history-table');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="loader"></div></td></tr>';
            
            // Construir query string
            let queryParams = `?page=${currentPage}&limit=${itemsPerPage}`;
            if (currentFilter !== 'all') {
                queryParams += `&status=${currentFilter}`;
            }
            
            fetchAPI(`/api/upload/history${queryParams}`)
                .then(data => {
                    const uploads = data.uploads;
                    totalPages = Math.ceil(data.total / itemsPerPage);
                    
                    if (uploads.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum upload encontrado</td></tr>';
                        document.getElementById('pagination-container').innerHTML = '';
                        return;
                    }
                    
                    tableBody.innerHTML = '';
                    uploads.forEach(upload => {
                        const statusClass = upload.status === 'completed' ? 'success' : 
                                          upload.status === 'pending' ? 'warning' : 
                                          upload.status === 'processing' ? 'info' : 'danger';
                        
                        const statusText = upload.status === 'completed' ? 'Concluído' : 
                                         upload.status === 'pending' ? 'Pendente' : 
                                         upload.status === 'processing' ? 'Processando' : 'Erro';
                        
                        tableBody.innerHTML += `
                            <tr>
                                <td>${upload.filename}</td>
                                <td>${formatFileType(upload.file_type)}</td>
                                <td>${formatDateTime(upload.upload_date)}</td>
                                <td>${formatFileSize(upload.file_size)}</td>
                                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-info text-white me-1" onclick="viewUploadDetails(${upload.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteFile(${upload.id}, '${upload.filename}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    // Atualizar paginação
                    updatePagination();
                })
                .catch(error => {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar histórico de uploads</td></tr>';
                    console.error('Erro ao carregar histórico de uploads:', error);
                });
        }
        
        // Função para atualizar paginação
        function updatePagination() {
            const paginationContainer = document.getElementById('pagination-container');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            const pagination = createPagination(currentPage, totalPages, function(page) {
                currentPage = page;
                loadUploadHistory();
            });
            
            paginationContainer.innerHTML = '';
            paginationContainer.appendChild(pagination);
        }
        
        // Função para formatar tipo de arquivo
        function formatFileType(type) {
            const types = {
                'payment': 'Pagamentos',
                'bonus': 'Bonificações',
                'discount': 'Descontos',
                'driver': 'Motoristas',
                'other': 'Outro'
            };
            
            return types[type] || type;
        }
        
        // Função para formatar tamanho de arquivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Função para lidar com upload de arquivo
        function handleFileUpload(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('file-input');
            const fileType = document.getElementById('file-type').value;
            const fileDescription = document.getElementById('file-description').value;
            const processImmediately = document.getElementById('process-immediately').checked;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('Selecione um arquivo para upload', 'error');
                return;
            }
            
            if (!fileType) {
                showNotification('Selecione o tipo de arquivo', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Verificar tamanho do arquivo (máx. 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('O arquivo excede o tamanho máximo permitido (10MB)', 'error');
                return;
            }
            
            // Verificar extensão do arquivo
            const allowedExtensions = ['csv', 'xls', 'xlsx'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedExtensions.includes(fileExtension)) {
                showNotification('Formato de arquivo não suportado. Use CSV, XLS ou XLSX', 'error');
                return;
            }
            
            // Mostrar modal de progresso
            const progressModal = new bootstrap.Modal(document.getElementById('uploadProgressModal'));
            progressModal.show();
            
            // Preparar FormData
            const formData = new FormData();
            formData.append('file', file);
            formData.append('file_type', fileType);
            formData.append('description', fileDescription);
            formData.append('process_immediately', processImmediately ? '1' : '0');
            
            // Configurar XMLHttpRequest para acompanhar o progresso
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('upload-progress-bar').style.width = percentComplete + '%';
                    document.getElementById('upload-progress-bar').setAttribute('aria-valuenow', percentComplete);
                    document.getElementById('upload-progress-bar').textContent = percentComplete + '%';
                    
                    if (percentComplete < 100) {
                        document.getElementById('upload-status-text').textContent = `Enviando arquivo... ${percentComplete}%`;
                    } else {
                        document.getElementById('upload-status-text').textContent = 'Processando arquivo...';
                    }
                }
            });
            
            xhr.addEventListener('load', function() {
                if (xhr.status === 200 || xhr.status === 201) {
                    // Upload bem-sucedido
                    progressModal.hide();
                    showNotification('Arquivo enviado com sucesso', 'success');
                    document.getElementById('upload-form').reset();
                    loadUploadHistory();
                } else {
                    // Erro no upload
                    progressModal.hide();
                    showNotification('Erro ao enviar arquivo: ' + (xhr.responseText || 'Erro desconhecido'), 'error');
                }
            });
            
            xhr.addEventListener('error', function() {
                progressModal.hide();
                showNotification('Erro de conexão ao enviar arquivo', 'error');
            });
            
            xhr.addEventListener('abort', function() {
                progressModal.hide();
                showNotification('Upload cancelado', 'warning');
            });
            
            xhr.open('POST', '/api/upload');
            xhr.send(formData);
        }
        
        // Função para visualizar detalhes do upload
        function viewUploadDetails(id) {
            selectedUploadId = id;
            
            fetchAPI(`/api/upload/${id}`)
                .then(upload => {
                    // Preencher informações do arquivo
                    document.getElementById('detail-filename').textContent = upload.filename;
                    document.getElementById('detail-type').textContent = formatFileType(upload.file_type);
                    document.getElementById('detail-description').textContent = upload.description || '-';
                    document.getElementById('detail-upload-date').textContent = formatDateTime(upload.upload_date);
                    document.getElementById('detail-size').textContent = formatFileSize(upload.file_size);
                    
                    const statusClass = upload.status === 'completed' ? 'success' : 
                                      upload.status === 'pending' ? 'warning' : 
                                      upload.status === 'processing' ? 'info' : 'danger';
                    
                    const statusText = upload.status === 'completed' ? 'Concluído' : 
                                     upload.status === 'pending' ? 'Pendente' : 
                                     upload.status === 'processing' ? 'Processando' : 'Erro';
                    
                    document.getElementById('detail-status').innerHTML = `<span class="badge bg-${statusClass}">${statusText}</span>`;
                    
                    // Preencher resultado do processamento
                    if (upload.status === 'completed') {
                        document.getElementById('detail-processing-result').innerHTML = `
                            <div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>
                                Arquivo processado com sucesso em ${formatDateTime(upload.processed_date)}.
                            </div>
                        `;
                    } else if (upload.status === 'error') {
                        document.getElementById('detail-processing-result').innerHTML = `
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Erro ao processar arquivo: ${upload.error_message || 'Erro desconhecido'}.
                            </div>
                        `;
                    } else if (upload.status === 'processing') {
                        document.getElementById('detail-processing-result').innerHTML = `
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Arquivo está sendo processado...
                            </div>
                        `;
                    } else {
                        document.getElementById('detail-processing-result').innerHTML = `
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-clock me-2"></i>
                                Arquivo aguardando processamento.
                            </div>
                        `;
                    }
                    
                    // Preencher estatísticas
                    document.getElementById('detail-total-records').textContent = upload.total_records || '-';
                    document.getElementById('detail-processed-records').textContent = upload.processed_records || '-';
                    document.getElementById('detail-error-records').textContent = upload.error_records || '0';
                    
                    // Configurar log de erros
                    if (upload.error_log) {
                        document.getElementById('detail-error-log').textContent = upload.error_log;
                        document.getElementById('error-log-container').style.display = 'block';
                    } else {
                        document.getElementById('error-log-container').style.display = 'none';
                    }
                    
                    // Configurar prévia dos dados
                    loadDataPreview(id);
                    
                    // Configurar botões
                    const processButton = document.getElementById('process-file-button');
                    if (upload.status === 'pending') {
                        processButton.style.display = 'block';
                    } else {
                        processButton.style.display = 'none';
                    }
                    
                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('uploadDetailsModal'));
                    modal.show();
                })
                .catch(error => {
                    showNotification('Erro ao carregar detalhes do upload', 'error');
                    console.error('Erro ao carregar detalhes do upload:', error);
                });
        }
        
        // Função para carregar prévia dos dados
        function loadDataPreview(id) {
            const previewTable = document.getElementById('detail-data-preview');
            
            fetchAPI(`/api/upload/${id}/preview`)
                .then(preview => {
                    if (!preview.headers || !preview.data || preview.data.length === 0) {
                        previewTable.innerHTML = `
                            <thead>
                                <tr>
                                    <th colspan="5" class="text-center">Prévia não disponível</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;
                        return;
                    }
                    
                    // Construir cabeçalho
                    let headerHtml = '<tr>';
                    preview.headers.forEach(header => {
                        headerHtml += `<th>${header}</th>`;
                    });
                    headerHtml += '</tr>';
                    
                    // Construir linhas de dados
                    let rowsHtml = '';
                    preview.data.forEach(row => {
                        rowsHtml += '<tr>';
                        row.forEach(cell => {
                            rowsHtml += `<td>${cell}</td>`;
                        });
                        rowsHtml += '</tr>';
                    });
                    
                    previewTable.innerHTML = `
                        <thead>${headerHtml}</thead>
                        <tbody>${rowsHtml}</tbody>
                    `;
                })
                .catch(error => {
                    previewTable.innerHTML = `
                        <thead>
                            <tr>
                                <th colspan="5" class="text-center text-danger">Erro ao carregar prévia</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    console.error('Erro ao carregar prévia dos dados:', error);
                });
        }
        
        // Função para baixar arquivo
        function downloadFile() {
            if (!selectedUploadId) return;
            
            window.location.href = `/api/upload/${selectedUploadId}/download`;
        }
        
        // Função para processar arquivo
        function processFile() {
            if (!selectedUploadId) return;
            
            const processButton = document.getElementById('process-file-button');
            const originalButtonText = processButton.innerHTML;
            processButton.disabled = true;
            processButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
            
            fetchAPI(`/api/upload/${selectedUploadId}/process`, { method: 'POST' })
                .then(() => {
                    showNotification('Arquivo enviado para processamento', 'success');
                    
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('uploadDetailsModal')).hide();
                    
                    // Recarregar histórico
                    loadUploadHistory();
                })
                .catch(error => {
                    showNotification('Erro ao processar arquivo', 'error');
                    console.error('Erro ao processar arquivo:', error);
                })
                .finally(() => {
                    processButton.disabled = false;
                    processButton.innerHTML = originalButtonText;
                });
        }
        
        // Função para confirmar exclusão de arquivo
        function confirmDeleteFile(id, filename) {
            selectedUploadId = id;
            document.getElementById('delete-filename').textContent = filename;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
            modal.show();
        }
        
        // Função para excluir arquivo
        function deleteFile() {
            if (!selectedUploadId) return;
            
            const deleteButton = document.getElementById('confirm-delete-button');
            const originalButtonText = deleteButton.innerHTML;
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Excluindo...';
            
            fetchAPI(`/api/upload/${selectedUploadId}`, { method: 'DELETE' })
                .then(() => {
                    showNotification('Arquivo excluído com sucesso', 'success');
                    
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal')).hide();
                    
                    // Recarregar histórico
                    loadUploadHistory();
                })
                .catch(error => {
                    showNotification('Erro ao excluir arquivo', 'error');
                    console.error('Erro ao excluir arquivo:', error);
                })
                .finally(() => {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = originalButtonText;
                    selectedUploadId = null;
                });
        }
    </script>
</body>
</html>
