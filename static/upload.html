<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload - MenezesLog SaaS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Menu Lateral -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-truck"></i> MenezesLog</h3>
        </div>
        <ul class="sidebar-menu">
            <li><a href="admin_dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="prestadores.html"><i class="fas fa-users"></i> Prestadores</a></li>
            <li><a href="upload.html" class="active"><i class="fas fa-upload"></i> Upload</a></li>
            <li><a href="tarifas.html"><i class="fas fa-dollar-sign"></i> Tarifas</a></li>
            <li><a href="ciclos.html"><i class="fas fa-calendar"></i> Ciclos</a></li>
            <li><a href="awbs.html"><i class="fas fa-barcode"></i> AWBs</a></li>
        </ul>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1><i class="fas fa-upload"></i> Upload de Arquivos</h1>
                <p>Faça upload de arquivos CSV de entregas para processamento</p>
            </div>

            <!-- Status do Sistema -->
            <div class="system-status">
                <div class="status-card">
                    <div class="status-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="status-content">
                        <h4>Status do Supabase</h4>
                        <span id="supabase-status" class="status-badge">Verificando...</span>
                    </div>
                </div>
                <div class="status-card">
                    <div class="status-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="status-content">
                        <h4>Entregadores Cadastrados</h4>
                        <span id="motoristas-count" class="status-number">0</span>
                    </div>
                </div>
                <div class="status-card">
                    <div class="status-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="status-content">
                        <h4>Versão do Sistema</h4>
                        <span class="status-badge">v7.5 FINAL</span>
                    </div>
                </div>
            </div>

            <!-- Área de Upload -->
            <div class="upload-section">
                <div class="upload-card">
                    <div class="card-header">
                        <h3><i class="fas fa-file-csv"></i> Upload de CSV de Entregas</h3>
                        <p>Arraste e solte seu arquivo CSV ou clique para selecionar</p>
                    </div>
                    
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h4>Arraste seu arquivo CSV aqui</h4>
                            <p>ou <span class="upload-link">clique para selecionar</span></p>
                            <small>Formatos suportados: CSV, Excel (.xlsx, .xls)</small>
                        </div>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                    </div>

                    <!-- Informações do Arquivo -->
                    <div id="fileInfo" class="file-info" style="display: none;">
                        <div class="file-details">
                            <i class="fas fa-file"></i>
                            <div class="file-text">
                                <strong id="fileName"></strong>
                                <span id="fileSize"></span>
                            </div>
                            <button id="removeFile" class="btn-remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Botão de Upload -->
                    <div class="upload-actions">
                        <button id="uploadBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-upload"></i> Processar Arquivo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div id="progressSection" class="progress-section" style="display: none;">
                <div class="progress-card">
                    <h4><i class="fas fa-cog fa-spin"></i> Processando Arquivo...</h4>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div class="progress-info">
                        <span id="progressText">Iniciando processamento...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                </div>
            </div>

            <!-- Resultados -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="results-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-bar"></i> Resultados do Processamento</h3>
                    </div>
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-icon success">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="result-content">
                                <h4 id="processedCount">0</h4>
                                <p>Entregas Processadas</p>
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-icon error">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="result-content">
                                <h4 id="errorCount">0</h4>
                                <p>Erros Encontrados</p>
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-icon info">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="result-content">
                                <h4 id="processingTime">0s</h4>
                                <p>Tempo de Processamento</p>
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-icon info">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <div class="result-content">
                                <h4 id="performance">0</h4>
                                <p>Linhas/Segundo</p>
                            </div>
                        </div>
                    </div>
                    <div class="results-message">
                        <p id="resultMessage"></p>
                    </div>
                </div>
            </div>

            <!-- Histórico de Uploads -->
            <div class="history-section">
                <div class="history-card">
                    <div class="card-header">
                        <h3><i class="fas fa-history"></i> Histórico de Uploads</h3>
                    </div>
                    <div class="history-content">
                        <div id="historyList" class="history-list">
                            <p class="no-history">Nenhum upload realizado ainda</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Variáveis globais
        let selectedFile = null;

        // Elementos DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressSection = document.getElementById('progressSection');
        const resultsSection = document.getElementById('resultsSection');

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            verificarStatusSistema();
            configurarUpload();
        });

        // Verificar status do sistema
        async function verificarStatusSistema() {
            try {
                // Status do Supabase
                const statusResponse = await fetch('/api/status');
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    const supabaseStatus = document.getElementById('supabase-status');
                    supabaseStatus.textContent = statusData.data.supabase_connected ? 'Conectado' : 'Desconectado';
                    supabaseStatus.className = statusData.data.supabase_connected ? 'status-badge success' : 'status-badge error';
                }

                // Contagem de motoristas
                const motoristasResponse = await fetch('/api/motoristas/count');
                if (motoristasResponse.ok) {
                    const motoristasData = await motoristasResponse.json();
                    document.getElementById('motoristas-count').textContent = motoristasData.count || 0;
                }

            } catch (error) {
                console.error('Erro ao verificar status:', error);
                document.getElementById('supabase-status').textContent = 'Erro';
                document.getElementById('supabase-status').className = 'status-badge error';
            }
        }

        // Configurar funcionalidade de upload
        function configurarUpload() {
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    selecionarArquivo(files[0]);
                }
            });

            // Click para selecionar
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    selecionarArquivo(e.target.files[0]);
                }
            });

            // Remover arquivo
            document.getElementById('removeFile').addEventListener('click', () => {
                removerArquivo();
            });

            // Upload
            uploadBtn.addEventListener('click', () => {
                if (selectedFile) {
                    processarArquivo();
                }
            });
        }

        // Selecionar arquivo
        function selecionarArquivo(file) {
            selectedFile = file;
            
            // Mostrar informações do arquivo
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatarTamanho(file.size);
            
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
            
            // Esconder resultados anteriores
            resultsSection.style.display = 'none';
        }

        // Remover arquivo
        function removerArquivo() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadBtn.disabled = true;
            progressSection.style.display = 'none';
            resultsSection.style.display = 'none';
        }

        // Processar arquivo
        async function processarArquivo() {
            if (!selectedFile) return;

            // Mostrar progress
            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';
            uploadBtn.disabled = true;

            // Simular progresso
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                atualizarProgresso(progress, 'Processando dados...');
            }, 500);

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                const startTime = Date.now();
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                atualizarProgresso(100, 'Processamento concluído!');

                const result = await response.json();
                const endTime = Date.now();
                const totalTime = (endTime - startTime) / 1000;

                setTimeout(() => {
                    progressSection.style.display = 'none';
                    mostrarResultados(result, totalTime);
                }, 1000);

            } catch (error) {
                clearInterval(progressInterval);
                console.error('Erro no upload:', error);
                
                setTimeout(() => {
                    progressSection.style.display = 'none';
                    mostrarErro('Erro ao processar arquivo: ' + error.message);
                }, 1000);
            }

            uploadBtn.disabled = false;
        }

        // Atualizar progresso
        function atualizarProgresso(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Mostrar resultados
        function mostrarResultados(result, totalTime) {
            if (result.success) {
                document.getElementById('processedCount').textContent = result.data.entregas_processadas || 0;
                document.getElementById('errorCount').textContent = result.data.entregas_erro || 0;
                document.getElementById('processingTime').textContent = totalTime.toFixed(1) + 's';
                document.getElementById('performance').textContent = result.data.performance_linhas_por_segundo || 0;
                document.getElementById('resultMessage').textContent = result.message || 'Processamento concluído com sucesso!';
                document.getElementById('resultMessage').className = 'success-message';
            } else {
                mostrarErro(result.error || 'Erro desconhecido');
            }
            
            resultsSection.style.display = 'block';
            
            // Atualizar status do sistema
            setTimeout(verificarStatusSistema, 2000);
        }

        // Mostrar erro
        function mostrarErro(message) {
            document.getElementById('processedCount').textContent = '0';
            document.getElementById('errorCount').textContent = '-';
            document.getElementById('processingTime').textContent = '-';
            document.getElementById('performance').textContent = '-';
            document.getElementById('resultMessage').textContent = message;
            document.getElementById('resultMessage').className = 'error-message';
            
            resultsSection.style.display = 'block';
        }

        // Formatar tamanho do arquivo
        function formatarTamanho(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>

