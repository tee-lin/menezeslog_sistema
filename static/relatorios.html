<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MenezesLog - Relatórios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Cabeçalho -->
    <header class="header">
        <div class="container-fluid">
            <div class="header-content">
                <div class="d-flex align-items-center">
                    <button id="sidebar-toggle" class="btn btn-light me-2">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">
                        <img src="assets/MENEZESLOG-MarcaAzulH.png" alt="MenezesLog Logo">
                    </div>
                </div>
                <div class="user-info" id="user-info">
                    <div class="dropdown">
                        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="avatar me-2">A</div>
                            <div>
                                <div class="user-name">Administrador</div>
                                <div class="user-role text-muted small">Admin</div>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="perfil.html"><i class="fas fa-user me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item" href="configuracoes.html"><i class="fas fa-cog me-2"></i>Configurações</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-button"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navegação Lateral -->
    <aside class="sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="admin_dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt nav-icon"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="motoristas.html" class="nav-link">
                        <i class="fas fa-truck nav-icon"></i>
                        <span>Motoristas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="bonificacoes.html" class="nav-link">
                        <i class="fas fa-award nav-icon"></i>
                        <span>Bonificações</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="descontos.html" class="nav-link">
                        <i class="fas fa-minus-circle nav-icon"></i>
                        <span>Descontos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="upload.html" class="nav-link">
                        <i class="fas fa-upload nav-icon"></i>
                        <span>Upload</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="relatorios.html" class="nav-link active">
                        <i class="fas fa-chart-bar nav-icon"></i>
                        <span>Relatórios</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="nota_fiscal.html" class="nav-link">
                        <i class="fas fa-file-invoice nav-icon"></i>
                        <span>Notas Fiscais</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="configuracoes.html" class="nav-link">
                        <i class="fas fa-cog nav-icon"></i>
                        <span>Configurações</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="main-content" id="main-content">
        <div class="container-fluid">
            <h1 class="mb-4">Relatórios</h1>
            
            <!-- Seleção de Relatório -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Gerar Novo Relatório</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="report-type" class="form-label">Tipo de Relatório</label>
                            <select class="form-select" id="report-type">
                                <option value="">Selecione um tipo...</option>
                                <option value="payment_summary">Resumo de Pagamentos</option>
                                <option value="driver_performance">Desempenho de Motoristas</option>
                                <option value="bonus_summary">Resumo de Bonificações</option>
                                <option value="discount_summary">Resumo de Descontos</option>
                                <option value="financial_statement">Demonstrativo Financeiro</option>
                                <option value="custom">Relatório Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="date-range" class="form-label">Período</label>
                            <select class="form-select" id="date-range">
                                <option value="current_month">Mês Atual</option>
                                <option value="last_month">Mês Anterior</option>
                                <option value="current_year">Ano Atual</option>
                                <option value="last_year">Ano Anterior</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3" id="custom-date-range" style="display: none;">
                            <label for="start-date" class="form-label">Data Início / Fim</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="start-date">
                                <input type="date" class="form-control" id="end-date">
                            </div>
                        </div>
                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" id="generate-report-button">
                                <i class="fas fa-cogs me-2"></i>Gerar Relatório
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros Adicionais (aparecem conforme o tipo de relatório) -->
                    <div id="additional-filters" class="mt-3" style="display: none;">
                        <h5>Filtros Adicionais</h5>
                        <div class="row" id="filters-container">
                            <!-- Filtros serão inseridos aqui via JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Área de Visualização do Relatório -->
            <div class="card" id="report-view-area" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0" id="report-title">Relatório</h5>
                    <div>
                        <button class="btn btn-sm btn-success me-2" id="export-excel-button">
                            <i class="fas fa-file-excel me-1"></i>Exportar para Excel
                        </button>
                        <button class="btn btn-sm btn-danger" id="export-pdf-button">
                            <i class="fas fa-file-pdf me-1"></i>Exportar para PDF
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="report-content" class="table-responsive">
                        <div class="text-center">
                            <p>Selecione um tipo de relatório e clique em "Gerar Relatório" para visualizar os dados.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Histórico de Relatórios Gerados -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Histórico de Relatórios</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Nome do Relatório</th>
                                    <th>Tipo</th>
                                    <th>Data de Geração</th>
                                    <th>Período</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="report-history-table">
                                <tr>
                                    <td colspan="5" class="text-center">Carregando histórico...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="history-pagination-container" class="mt-4">
                        <!-- Paginação do histórico -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Rodapé -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="footer-text">
                <p>© 2025 MenezesLog - Sistema de Pagamento de Motoristas</p>
                <p class="text-muted small">Versão 1.0.0</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/main_v2.js"></script>
    <script>
        // Variáveis globais
        let currentHistoryPage = 1;
        let totalHistoryPages = 1;
        let itemsPerPage = 10;

        document.addEventListener("DOMContentLoaded", function() {
            // Carregar histórico de relatórios
            loadReportHistory();

            // Configurar eventos
            document.getElementById("report-type").addEventListener("change", handleReportTypeChange);
            document.getElementById("date-range").addEventListener("change", handleDateRangeChange);
            document.getElementById("generate-report-button").addEventListener("click", generateReport);
            document.getElementById("export-excel-button").addEventListener("click", () => exportReport("excel"));
            document.getElementById("export-pdf-button").addEventListener("click", () => exportReport("pdf"));
            
            // Verificar se deve gerar relatório automaticamente (via query param)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("generate") === "true") {
                // Poderia pré-selecionar um tipo de relatório e gerar
                // Ex: document.getElementById("report-type").value = "payment_summary";
                // generateReport();
                showNotification("Selecione o tipo de relatório e clique em Gerar", "info");
            }
        });

        function handleReportTypeChange() {
            const reportType = document.getElementById("report-type").value;
            const additionalFiltersDiv = document.getElementById("additional-filters");
            const filtersContainer = document.getElementById("filters-container");
            filtersContainer.innerHTML = ""; // Limpar filtros anteriores

            if (reportType === "driver_performance") {
                filtersContainer.innerHTML = `
                    <div class="col-md-4 mb-3">
                        <label for="filter-driver" class="form-label">Motorista Específico</label>
                        <select class="form-select" id="filter-driver">
                            <option value="all">Todos os Motoristas</option>
                            <!-- Motoristas carregados via JS -->
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-metric" class="form-label">Métrica Principal</label>
                        <select class="form-select" id="filter-metric">
                            <option value="total_paid">Total Pago</option>
                            <option value="deliveries">Entregas Realizadas</option>
                            <option value="bonuses">Bonificações Recebidas</option>
                        </select>
                    </div>
                `;
                loadDriversForFilter();
                additionalFiltersDiv.style.display = "block";
            } else if (reportType === "custom") {
                 filtersContainer.innerHTML = `
                    <div class="col-md-12 mb-3">
                        <label for="filter-custom-query" class="form-label">Consulta Personalizada (Avançado)</label>
                        <textarea class="form-control" id="filter-custom-query" rows="3" placeholder="Ex: SELECT * FROM payments WHERE amount > 1000"></textarea>
                        <div class="form-text">Use com cautela. Apenas para usuários avançados.</div>
                    </div>
                `;
                additionalFiltersDiv.style.display = "block";
            } else {
                additionalFiltersDiv.style.display = "none";
            }
        }

        function loadDriversForFilter() {
            const driverSelect = document.getElementById("filter-driver");
            if (!driverSelect) return;

            fetchAPI("/api/drivers?limit=1000&status=active")
                .then(data => {
                    data.drivers.forEach(driver => {
                        driverSelect.innerHTML += `<option value="${driver.driver_id}">${driver.name}</option>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar motoristas para filtro:", error));
        }

        function handleDateRangeChange() {
            const dateRange = document.getElementById("date-range").value;
            const customDateRangeDiv = document.getElementById("custom-date-range");
            if (dateRange === "custom") {
                customDateRangeDiv.style.display = "block";
            } else {
                customDateRangeDiv.style.display = "none";
            }
        }

        function generateReport() {
            const reportType = document.getElementById("report-type").value;
            const dateRange = document.getElementById("date-range").value;
            const startDate = document.getElementById("start-date").value;
            const endDate = document.getElementById("end-date").value;
            const reportViewArea = document.getElementById("report-view-area");
            const reportContentDiv = document.getElementById("report-content");
            const reportTitle = document.getElementById("report-title");

            if (!reportType) {
                showNotification("Selecione um tipo de relatório.", "error");
                return;
            }

            if (dateRange === "custom" && (!startDate || !endDate)) {
                showNotification("Selecione as datas de início e fim para período personalizado.", "error");
                return;
            }
            
            reportTitle.textContent = `Relatório: ${document.getElementById("report-type").options[document.getElementById("report-type").selectedIndex].text}`;
            reportContentDiv.innerHTML = `<div class="text-center p-5"><div class="loader"></div><p class="mt-2">Gerando relatório...</p></div>`;
            reportViewArea.style.display = "block";

            // Coletar filtros adicionais
            const filters = {};
            if (reportType === "driver_performance") {
                filters.driver_id = document.getElementById("filter-driver")?.value;
                filters.metric = document.getElementById("filter-metric")?.value;
            } else if (reportType === "custom") {
                filters.custom_query = document.getElementById("filter-custom-query")?.value;
            }

            const requestBody = {
                report_type: reportType,
                date_range: dateRange,
                start_date: startDate,
                end_date: endDate,
                filters: filters
            };

            fetchAPI("/api/reports/generate", { method: "POST", body: JSON.stringify(requestBody) })
                .then(data => {
                    if (data.error) {
                        reportContentDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }
                    // Renderizar o relatório (pode ser uma tabela, gráfico, etc.)
                    renderReportData(data, reportType);
                    // Adicionar ao histórico (simulação, o backend deveria fazer isso)
                    // addReportToHistory(reportType, dateRange, startDate, endDate);
                    loadReportHistory(); // Recarregar histórico após gerar novo
                })
                .catch(error => {
                    reportContentDiv.innerHTML = `<div class="alert alert-danger">Erro ao gerar relatório: ${error.message}</div>`;
                    console.error("Erro ao gerar relatório:", error);
                });
        }

        function renderReportData(data, reportType) {
            const reportContentDiv = document.getElementById("report-content");
            if (!data || !data.data || data.data.length === 0) {
                reportContentDiv.innerHTML = `<div class="alert alert-info">Nenhum dado encontrado para este relatório.</div>`;
                return;
            }

            let html = "<table class=\"table table-bordered table-striped table-sm\">";
            // Cabeçalho da tabela
            html += "<thead><tr>";
            data.headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += "</tr></thead>";

            // Corpo da tabela
            html += "<tbody>";
            data.data.forEach(row => {
                html += "<tr>";
                data.headers.forEach(header => {
                    // Tenta acessar o valor usando o header como chave. Se for um objeto, usa a chave. Se for array, usa o índice.
                    let cellValue = "";
                    if (typeof row === 'object' && row !== null) {
                         // Ajuste para encontrar a chave correta, case-insensitive e com underscores
                        const key = Object.keys(row).find(k => k.toLowerCase().replace(/_/g, '') === header.toLowerCase().replace(/_/g, ''));
                        cellValue = row[key] !== undefined ? row[key] : "-";
                    } else if (Array.isArray(row)) {
                        // Se for um array, precisamos de um mapeamento de header para índice, ou assumir a ordem.
                        // Para simplificar, vamos assumir que a ordem dos headers corresponde à ordem dos dados na linha.
                        const headerIndex = data.headers.indexOf(header);
                        cellValue = row[headerIndex] !== undefined ? row[headerIndex] : "-";
                    }
                    
                    // Formatar valores numéricos como moeda se aplicável
                    if (typeof cellValue === 'number' && (header.toLowerCase().includes('valor') || header.toLowerCase().includes('total') || header.toLowerCase().includes('pagamento'))) {
                        cellValue = formatCurrency(cellValue);
                    }
                    // Formatar datas
                    if (typeof cellValue === 'string' && (header.toLowerCase().includes('data') || header.toLowerCase().includes('date'))) {
                         if (cellValue.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) { // Verifica se é um timestamp completo
                            cellValue = formatDateTime(cellValue);
                         } else if (cellValue.match(/^\d{4}-\d{2}-\d{2}$/)) { // Verifica se é apenas data
                            cellValue = formatDate(cellValue);
                         }
                    }
                    html += `<td>${cellValue}</td>`;
                });
                html += "</tr>";
            });
            html += "</tbody></table>";

            // Adicionar resumo se houver
            if (data.summary) {
                html += "<div class=\"mt-3 p-3 bg-light rounded\"><h5>Resumo</h5>";
                for (const key in data.summary) {
                    let summaryValue = data.summary[key];
                    if (typeof summaryValue === 'number') {
                        summaryValue = formatCurrency(summaryValue);
                    }
                    html += `<p><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${summaryValue}</p>`;
                }
                html += "</div>";
            }
            
            reportContentDiv.innerHTML = html;
        }

        function exportReport(format) {
            const reportType = document.getElementById("report-type").value;
            const dateRange = document.getElementById("date-range").value;
            const startDate = document.getElementById("start-date").value;
            const endDate = document.getElementById("end-date").value;

            if (!reportType) {
                showNotification("Gere um relatório antes de exportar.", "warning");
                return;
            }
            
            // Coletar filtros adicionais
            const filters = {};
            if (reportType === "driver_performance") {
                filters.driver_id = document.getElementById("filter-driver")?.value;
                filters.metric = document.getElementById("filter-metric")?.value;
            } else if (reportType === "custom") {
                filters.custom_query = document.getElementById("filter-custom-query")?.value;
            }

            const requestBody = {
                report_type: reportType,
                date_range: dateRange,
                start_date: startDate,
                end_date: endDate,
                format: format,
                filters: filters
            };

            showNotification(`Exportando relatório para ${format.toUpperCase()}...`, "info");

            fetchAPI("/api/reports/export", { 
                method: "POST", 
                body: JSON.stringify(requestBody),
                responseType: 'blob' // Indicar que esperamos um blob
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                a.download = `relatorio_${reportType}_${new Date().toISOString().slice(0,10)}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                showNotification("Relatório exportado com sucesso!", "success");
            })
            .catch(error => {
                showNotification(`Erro ao exportar relatório: ${error.message}`, "error");
                console.error("Erro ao exportar relatório:", error);
            });
        }

        function loadReportHistory() {
            const tableBody = document.getElementById("report-history-table");
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center"><div class="loader"></div></td></tr>`;

            fetchAPI(`/api/reports/history?page=${currentHistoryPage}&limit=${itemsPerPage}`)
                .then(data => {
                    totalHistoryPages = Math.ceil(data.total / itemsPerPage);
                    tableBody.innerHTML = "";
                    if (data.reports.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Nenhum relatório no histórico.</td></tr>`;
                        updateHistoryPagination();
                        return;
                    }
                    data.reports.forEach(report => {
                        tableBody.innerHTML += `
                            <tr>
                                <td>${report.name || report.report_type.replace(/_/g, ' ')}</td>
                                <td>${report.report_type.replace(/_/g, ' ')}</td>
                                <td>${formatDateTime(report.generated_at)}</td>
                                <td>${report.period_start ? formatDate(report.period_start) + ' - ' + formatDate(report.period_end) : report.date_range}</td>
                                <td>
                                    <button class="btn btn-sm btn-info text-white me-1" onclick="viewReportFromHistory(${report.id})"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteReportFromHistory(${report.id})"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    updateHistoryPagination();
                })
                .catch(error => {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Erro ao carregar histórico.</td></tr>`;
                    console.error("Erro ao carregar histórico de relatórios:", error);
                });
        }
        
        function updateHistoryPagination() {
            const paginationContainer = document.getElementById("history-pagination-container");
            if (totalHistoryPages <= 1) {
                paginationContainer.innerHTML = "";
                return;
            }
            const pagination = createPagination(currentHistoryPage, totalHistoryPages, (page) => {
                currentHistoryPage = page;
                loadReportHistory();
            });
            paginationContainer.innerHTML = "";
            paginationContainer.appendChild(pagination);
        }

        function viewReportFromHistory(reportId) {
            showNotification("Carregando relatório do histórico...", "info");
            fetchAPI(`/api/reports/${reportId}`)
                .then(reportData => {
                    if (reportData.error) {
                        showNotification(`Erro: ${reportData.error}`, "error");
                        return;
                    }
                    // Preencher campos de seleção
                    document.getElementById("report-type").value = reportData.report_type;
                    handleReportTypeChange(); // Para carregar filtros adicionais se houver
                    document.getElementById("date-range").value = reportData.date_range;
                    handleDateRangeChange();
                    if(reportData.date_range === 'custom'){
                        document.getElementById("start-date").value = reportData.period_start.split('T')[0];
                        document.getElementById("end-date").value = reportData.period_end.split('T')[0];
                    }
                    // Preencher filtros adicionais se existirem no reportData.filters
                    if(reportData.filters){
                        for(const key in reportData.filters){
                            const filterElement = document.getElementById(`filter-${key}`);
                            if(filterElement) filterElement.value = reportData.filters[key];
                        }
                    }
                    
                    // Renderizar os dados do relatório
                    renderReportData(reportData.data, reportData.report_type);
                    document.getElementById("report-title").textContent = `Relatório: ${reportData.name || reportData.report_type.replace(/_/g, ' ')}`;
                    document.getElementById("report-view-area").style.display = "block";
                    window.scrollTo(0, document.getElementById('report-view-area').offsetTop - 80); // Scroll para a área do relatório
                })
                .catch(error => {
                    showNotification("Erro ao carregar relatório do histórico.", "error");
                    console.error("Erro ao carregar relatório do histórico:", error);
                });
        }

        function deleteReportFromHistory(reportId) {
            if (confirm("Tem certeza que deseja excluir este relatório do histórico?")) {
                fetchAPI(`/api/reports/history/${reportId}`, { method: "DELETE" })
                    .then(() => {
                        showNotification("Relatório excluído do histórico.", "success");
                        loadReportHistory();
                    })
                    .catch(error => {
                        showNotification("Erro ao excluir relatório do histórico.", "error");
                        console.error("Erro ao excluir relatório:", error);
                    });
            }
        }

    </script>
</body>
</html>
